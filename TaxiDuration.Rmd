---
title: "Survival Project"
author: "Madeline Abbott, Katja McKiernan, Hayley Stutzman"
date: "March 1, 2018"
output: html_document
---


## Things to do:

* remove pick-up and drop-off locations that are far away or in the ocean--check for reasonables travel speeds
* remove trips with extra long durations
* remove trips with really short (like 10 second) durations
* add a rush hour variable
* Kaplan-Meier curves--trip duration by rush hour (maybe time of day), trip duration by passenger number, trip duration by pickup location (airport?), trip duration by day of the week


## Other things (later):

* control for rush hour by day
* neighborhood
* what does store and forward flag mean?


Some packages...
```{r}
library(readr)
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
library(dplyr)
library(survival)
library(geosphere)
library(lubridate)
#library(osrm)
library(tidyr)
#library(survminer)
```

## Read in data:
```{r}
Taxi <- read.csv("Taxi.csv")
dim(Taxi)
```

### A first look at the data:

### Create a histogram of trip durations
```{r}
ggplot(Taxi, aes(trip_duration)) + geom_histogram(fill = "yellow", col = "black", bins = 200) + scale_x_log10()
```

### A map of pick-up locations
```{r}
states <- map_data("state")
ggplot(data = states) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = Taxi, aes(x = pickup_longitude, y = pickup_latitude), color = "black", size = 2, alpha = 0.5) 
```
### A map of drop-off locations
```{r}
ggplot(data = states) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = Taxi, aes(x = dropoff_longitude, y = dropoff_latitude), color = "black", size = 2, alpha = 0.5) 
```


### A map of long trips with duration over 12 hours (43200 seconds)
```{r}
longTaxi <- Taxi %>%
  filter(trip_duration > 43200)

ggplot(data = states) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = longTaxi, aes(x = dropoff_longitude, y = dropoff_latitude), color = "black", size = 2, alpha = 0.5) 
```

### A map of short trips with duration under 30 seconds
```{r}
shortTaxi <- Taxi %>%
  filter(trip_duration < 30)

ggplot(data = states) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = shortTaxi, aes(x = dropoff_longitude, y = dropoff_latitude), color = "black", size = 2, alpha = 0.5) 
```



## Data Cleaning:

```{r}
# So far this limits longitude to between -90 and -60 degrees, and latitude to between 37 and 43 degrees,
#cleanTaxi <- Taxi %>%
#  filter(-70 > pickup_longitude) %>% filter(pickup_longitude > -90) %>%
#  filter(37 < pickup_latitude) %>% filter(pickup_latitude < 43) %>%
#  filter(-70 > dropoff_longitude) %>% filter(dropoff_longitude > -90) %>%
#  filter(37 < dropoff_latitude) %>% filter(dropoff_latitude < 43)

# calculate average speed (approximate) and restrict to average speed of over 2 mph and under 70 mph.
#getDistance <- function(location_data) {distGeo(c(location_data[1], location_data[2]), c(location_data[3], #location_data[4]))}
#cleanTaxi$distance_traveled <- apply(cleanTaxi[c("pickup_longitude", "pickup_latitude", "dropoff_longitude", #"dropoff_latitude")], 1, getDistance)  # in meters, distance "as the crow flies"
# convert to miles
#cleanTaxi$distance_traveled <- cleanTaxi$distance_traveled*0.000621371
# get average speed
#cleanTaxi$average_speed <- cleanTaxi$distance_traveled / (cleanTaxi$trip_duration/60/60)
# filter out really slow and really fast taxis
#cleanTaxi2 <- cleanTaxi %>%
#  filter(average_speed > 2) %>% filter(average_speed < 70)

# Restricts duration to under 80000 seconds (about 22 hours) and over 10 seconds
#cleanTaxi3 <- cleanTaxi2 %>%
#  filter(trip_duration > 10) %>%
#  filter(trip_duration < 80000)


# save the cleaner version of the data
#write.csv(cleanTaxi3, file = "cleanTaxi.csv")
```


# Load in clean data

**also remove trips with 0 passengers**
```{r}
cleanTaxi <- read.csv("cleanTaxi.csv") %>%
  filter(passenger_count > 0)
```

** Make a map of the clean data**
```{r}
# make another map
states <- map_data("state")
new_york_areas <- subset(states, region %in% c("new york", "new jersey", "connecticut", "pennsylvania"))
# drop off
ggplot(data = new_york_areas) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = cleanTaxi, aes(x = dropoff_longitude, y = dropoff_latitude), color = "black", size = 2, alpha = 0.3) + xlab("Longitude") + ylab("Latitude") + ggtitle("Drop-off Locations")
# pick up
ggplot(data = new_york_areas) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = cleanTaxi, aes(x = pickup_longitude, y = pickup_latitude), color = "black", size = 2, alpha = 0.3) + xlab("Longitude") + ylab("Latitude") + ggtitle("Pick-up Locations")

```





# Preliminary Analysis:

** use cleanTaxi data **

## Plot trip duration with a Kaplan-Meier curve
```{r}
KM_taxi <- survfit(Surv(trip_duration) ~ 1, data = cleanTaxi)
plot(KM_taxi, col = 'purple', xlim = c(0, 23500), xlab = "Trip Duration (seconds)", ylab = "Survival Estimate", main = "Taxi Trip Duration")
```


## Survival curve with weibull distribution
```{r}
Weib_taxi <- survreg(Surv(trip_duration) ~ 1, dist = "weibull", data = cleanTaxi)

curve(1 - pweibull(x, shape = 1/0.7045081, scale = exp(6.83227)), from = 0, to = 23500)

haz_taxi <- function(x) {dweibull(x, shape = 1/0.7045081, scale = exp(6.83227)) / (1-pweibull(x, shape = 1/0.7045081, scale = exp(6.83227)))}

plot(haz_taxi, from = 0, to = 23500)
```



### Find mean trip duration
```{r}
AUCKM = function(survobj,duration)
{
base=c(0,summary(survobj)$time,max(duration))
heights=c(1,summary(survobj)$surv)
new=c()
for(i in 1:length(heights)) { new=c(new,(base[i+1]-base[i])*heights[i]) }
c(sum(new))
}

AUCKM(KM_taxi, cleanTaxi$trip_duration)
```


## Trip duration by passenger number
```{r}
KM_taxi <- survfit(Surv(trip_duration) ~ as.factor(passenger_count), data = cleanTaxi)
plot(KM_taxi, col = c('red', 'orange', 'gold', 'green', 'cyan', 'purple'), xlim = c(0, 23500), xlab = "Trip Duration (seconds)", ylab = "Survival Estimate", main = "Taxi Trip Duration by Passenger Count")
legend("topright", inset = 0.05, title = "Number of passengers", legend = c("1", "2", "3", "4", "5", "6"), fill = c('red', 'orange', 'gold', 'green', 'cyan', 'purple'))

# zoom in
plot(KM_taxi, col = c('red', 'orange', 'gold', 'green', 'cyan', 'purple'), xlim = c(0, 3000), xlab = "Trip Duration (seconds)", ylab = "Survival Estimate", main = "Taxi Trip Duration by Passenger Count")
legend("topright", inset = 0.05, title = "Number of passengers", legend = c("1", "2", "3", "4", "5", "6"), fill = c('red', 'orange', 'gold', 'green', 'cyan', 'purple'))
```

### Log rank test
```{r}
survdiff(Surv(trip_duration) ~ as.factor(passenger_count), data = cleanTaxi)
1 - pchisq((314.117 + 707.589 + 110.091 + 152.807 + 5.734 + 0.522), df = 5)
```

### AFT model
```{r}
m <- survreg(Surv(trip_duration) ~ as.factor(passenger_count), dist = "weibull", data = cleanTaxi)
summary(m)

surv <- function(x) {1-pweibull(x, shape = 1/0.704, scale = exp(6.8181))}
integrate(surv, 0, Inf)


# one passenger mean trip time
surv <- function(x) {1-pweibull(x, shape = 1/0.704, scale = exp(6.8181))}
integrate(surv, 0, Inf)
# two passengers mean trip time
surv <- function(x) {1-pweibull(x, shape = 1/0.704, scale = exp(6.8181 + 0.0628))}
integrate(surv, 0, Inf)
# three passengers mean trip time
surv <- function(x) {1-pweibull(x, shape = 1/0.704, scale = exp(6.8181 + 0.0476))}
integrate(surv, 0, Inf)
# four passengers mean trip time
surv <- function(x) {1-pweibull(x, shape = 1/0.704, scale = exp(6.8181 + 0.0751))}
integrate(surv, 0, Inf)
# five passengers mean trip time
surv <- function(x) {1-pweibull(x, shape = 1/0.704, scale = exp(6.8181 + 0.0203))}
integrate(surv, 0, Inf)
# six passengers mean trip time
surv <- function(x) {1-pweibull(x, shape = 1/0.704, scale = exp(6.8181 + 0.0116))}
integrate(surv, 0, Inf)
```

## Trip duration by month
```{r}
cleanTaxi$month <- unlist(lapply(cleanTaxi$pickup_datetime, lubridate::month))

library(survival)
KM_month <- survfit(Surv(trip_duration) ~ as.factor(month), data = cleanTaxi)
plot(KM_month, col = c('red', 'orange', 'gold', 'green', 'cyan', 'purple'), xlim = c(0, 5000), xlab = "Trip Duration (seconds)", ylab = "Survival Estimate", main = "Taxi Trip Duration by Month")
legend("topright", inset = 0.05, title = "Month", legend = c("1", "2", "3", "4", "5", "6"), fill = c('red', 'orange', 'gold', 'green', 'cyan', 'purple'))
```

### AFT model of duration by month
```{r}
m <- survreg(Surv(trip_duration) ~ as.factor(month), dist = "weibull", data = cleanTaxi)
summary(m)

# jan
surv <- function(x) {1-pweibull(x, shape = 1/0.702, scale = exp(6.77320))}
integrate(surv, 0, Inf)
# feb
surv <- function(x) {1-pweibull(x, shape = 1/0.702, scale = exp(6.77320 + -0.00355))}
integrate(surv, 0, Inf)
# mar
surv <- function(x) {1-pweibull(x, shape = 1/0.702, scale = exp(6.77320 + 0.03346))}
integrate(surv, 0, Inf)
# apr
surv <- function(x) {1-pweibull(x, shape = 1/0.702, scale = exp(6.77320 + 0.07207))}
integrate(surv, 0, Inf)
# may
surv <- function(x) {1-pweibull(x, shape = 1/0.702, scale = exp(6.77320 + 0.12043))}
integrate(surv, 0, Inf)
# jun
surv <- function(x) {1-pweibull(x, shape = 1/0.702, scale = exp(6.77320 + 0.12584))}
integrate(surv, 0, Inf)
```



## Creating a Rush Hour variable 
```{r}
# Sample data set for adding rush hour
tripIDTest = c(1,2,3,4,5,6,7,8,9,10)
TimeTest = c(16,16, 8,9.5,6,3,1,12, 8.75, 10)
TestTaxi = data.frame(tripIDTest,TimeTest)
TestTaxi
# Function for adding a rush hour variable-this will work once we figure out a good way to extract the time of day from the dataset
CreateRush <- function(data1,timeCat){
  rush = c( 1:nrow(data1))
  for(i in 1:nrow(data1)){
    if(hour(timeCat[i]) <= 8 && hour(timeCat[i]) >= 6 ){
      rush[i] = 1
    }
    else if(hour(timeCat[i]) >= 15 && hour(timeCat[i]) <= 17){
      rush[i] = 2
    }
    else{
      rush[i] = 0
    }
  }
  return(newdata1 = (cbind(data1, rush)))
}

```


```{r}
# Extracting time only from pickup info
cleanTaxi$pickup_datetime = ymd_hms(cleanTaxi$pickup_datetime)
#Adding rush hour variable to cleanTaxi
cleanTaxi = CreateRush(cleanTaxi, cleanTaxi$pickup_datetime)

```


```{r}
KMRush = survfit(Surv(cleanTaxi$trip_duration)~cleanTaxi$rush, conf.type = "plain")

plot(KMRush, col = c("black", "red", "green"), xlim= c(0,5000), xlab = "Trip Duration (seconds)", ylab = "Survival Estimate", main = "Taxi Trip Duration by Rush Hour")
legend("topright", inset = 0.05, title = "Rush Hour Indicator", legend = c("0", "1", "2"), fill = c('black', 'red', 'green'))

survdiff(Surv(cleanTaxi$trip_duration)~cleanTaxi$rush)

coxRushDist = coxph(Surv(cleanTaxi$trip_duration)~cleanTaxi$rush*cleanTaxi$distance_traveled)
summary(coxRushDist)

cox.zph(coxRushDist)


KMRushDist = survfit(Surv(cleanTaxi$trip_duration)~cleanTaxi$rush+cleanTaxi$distance_traveled, conf.type = "plain")
```



# Weather

Join Taxi data with Weather data
```{r}
WeatherData <- read.csv("WeatherTaxi.csv")
WeatherData$date <- format(as.Date(WeatherData$date, format = "%d-%m-%Y"), "%Y-%m-%d")
cleanTaxi$date <- format(as.Date(cleanTaxi$pickup_datetime, format = "%Y-%m-%d  %H:%M"), "%Y-%m-%d")
TaxiWeather <- merge(cleanTaxi, WeatherData, by = "date")

#precipitation
TaxiWeather$precipitation <- as.numeric(as.character(TaxiWeather$precipitation))
TaxiWeather$precipitation[is.na(TaxiWeather$precipitation)] <- 0.01
#snow.fall
TaxiWeather$snow.fall <- as.numeric(as.character(TaxiWeather$snow.fall))
TaxiWeather$snow.fall[is.na(TaxiWeather$snow.fall)] <- 0.01
#snow.depth
TaxiWeather$snow.depth <- as.numeric(as.character(TaxiWeather$snow.depth))
TaxiWeather$snow.depth[is.na(TaxiWeather$snow.depth)] <- 0.01
```


### Trip duration by precipitation

Try modeling with exponential, weibull, and log normal distributions.  Use Cox Snell residuals to compare fits.
```{r}
# Exponential
mod_precip_exp <- survreg(Surv(trip_duration) ~ precipitation, data = TaxiWeather, dist = "exponential")
summary(mod_precip_exp)
# Cox Snell Residuals
CoxSnell = function(cs,status,xlim=NULL,ylim=NULL)
{
kmcs=survfit(Surv(jitter(cs,amount=(max(cs)-min(cs))/1000),status)~1)$surv
plot(log(-log(kmcs))~sort(log(cs)),xlab="log(Cox-Snell)",ylab="log(-log(S(Cox-Snell)))",xlim=xlim,ylim=ylim)
abline(0,1,col='red')
}
# Plot only a sample of 1000 CS residuals
cs = -log( 1 - pexp(TaxiWeather$trip_duration, 1/exp(6.7331 + -0.0394*TaxiWeather$precipitation)))
# smaller sample of cs residuals
cs_sample <- sample(cs, 1000)
status <- rep(1, length(cs_sample))
CoxSnell(cs_sample, status)

# Weibull
mod_precip_weib <- survreg(Surv(trip_duration) ~ precipitation, data = TaxiWeather, dist = "weibull")
summary(mod_precip_weib)
# Plot only a sample of 1000 CS residuals
cs = -log( 1 - pweibull(TaxiWeather$trip_duration, shape = 1/0.704, scale = exp(6.8356 + -0.0392*TaxiWeather$precipitation)))
# smaller sample of cs residuals
cs_sample <- sample(cs, 1000)
status <- rep(1, length(cs_sample))
CoxSnell(cs_sample, status)

# Log normal
mod_precip_lnorm <- survreg(Surv(trip_duration) ~ precipitation, data = TaxiWeather, dist = "lognormal")
summary(mod_precip_lnorm)
# Plot only a sample of 1000 CS residuals
cs = -log( 1 - plnorm(TaxiWeather$trip_duration, mean = 6.4724 + -0.0402*TaxiWeather$precipitation, sd = 0.741))
# smaller sample of cs residuals
cs_sample <- sample(cs, 1000)
status <- rep(1, length(cs_sample))
CoxSnell(cs_sample, status)

# Log normal look the best!


# Trip duration by precipitation (controlling for distance)
summary(survreg(Surv(trip_duration) ~ precipitation*distance_traveled, data = TaxiWeather), dist = "lognormal")
```

### Q: How does the type of weather affect trip duration?

Make new categorical variable: fair weather, rain, snow
```{r}
TaxiWeather <- TaxiWeather %>%
    mutate(weather = ifelse(snow.fall > 0, "snow", ifelse(precipitation > 0, "rain", "fair"))) 
```

Then make models (with and without controlling for distance)
```{r}
summary(survreg(Surv(trip_duration) ~ weather, data = TaxiWeather), dist = "lognormal")
summary(survreg(Surv(trip_duration) ~ weather*distance_traveled, data = TaxiWeather), dist = "lognormal")
```



# Taxi Routes

* looking at bike lanes, busy streets, snow priority...

Use shortest road routes between start and end.
```{r}
# shorests routes for each taxi ride
Routes1 <- read.csv("fastest_routes_train_part_1.csv")
Routes2 <- read.csv("fastest_routes_train_part_2.csv")

# join routes with taxi data
RoutesAll <- rbind(Routes1, Routes2)
TaxiRoutes <- merge(cleanTaxi, RoutesAll, by = "id")
```

Separating list of taxi route streets into columns
```{r}
#TaxiRoutes$street_for_each_step = sapply(TaxiRoutes$street_for_each_step, FUN = toupper)

#TaxiRoutes <- separate(TaxiRoutes, 'street_for_each_step', paste("street_for_each_step", #1:max(TaxiRoutes$number_of_steps), sep="_"), sep="\\|", extra="drop")

#write.csv(TaxiRoutes, file = "TaxiRoutes.csv")
TaxiRoutes <- read.csv("TaxiRoutes.csv")
miniTaxiRoutes <- TaxiRoutes[sample(nrow(TaxiRoutes), 100), ]
```

Add information about streets (working here...)
```{r}
#Street info:
# (Note: first need to make street names consistent between StreetInfo dataset and TaxiRoutes dataset)
StreetInfo <- read.csv("nyc_centerline.csv")
View(StreetInfo)

StreetInfo$street <- sub("\\<AVE\\>", "AVENUE", StreetInfo$street)
StreetInfo$street <- sub("\\<ST\\>", "STREET", StreetInfo$street)
StreetInfo$street <- sub("\\<BLVD\\>", "BOULEVARD", StreetInfo$street)
StreetInfo$street <- sub("\\<RD\\>", "ROAD", StreetInfo$street)
StreetInfo$street <- sub("\\<LN\\>", "LANE", StreetInfo$street)
StreetInfo$street <- sub("\\<CT\\>", "COURT", StreetInfo$street)
StreetInfo$street <- sub("\\<PL\\>", "PLACE", StreetInfo$street)
StreetInfo$street <- sub("\\<PKWY\\>", "PARKWAY", StreetInfo$street)
StreetInfo$street <- sub("\\<DR\\>", "DRIVE", StreetInfo$street)
StreetInfo$street <- sub("\\<BRG\\>", "BRIDGE", StreetInfo$street)
StreetInfo$street <- sub("\\<EXPY\\>", "EXPRESSWAY", StreetInfo$street)
StreetInfo$street <- sub("\\<PLZ\\>", "PLAZA", StreetInfo$street)
StreetInfo$street <- sub("\\<LOOP\\>", "LOOP", StreetInfo$street)
StreetInfo$street <- sub("\\<XING\\>", "CROSSING", StreetInfo$street)
StreetInfo$street <- sub("\\<CIR\\>", "CIRCLE", StreetInfo$street)
StreetInfo$street <- sub("\\<TER\\>", "TERRACE", StreetInfo$street)
StreetInfo$street <- sub("\\<XING\\>", "CROSSING", StreetInfo$street)
StreetInfo$street <- sub("\\<APPR\\>", "APPROACH", StreetInfo$street)
StreetInfo$street <- sub("\\<CRES\\>", "CRESCENT", StreetInfo$street)
StreetInfo$street <- sub("\\<SQ\\>", "SQUARE", StreetInfo$street)
StreetInfo$street <- sub("\\<ALY\\>", "ALLEY", StreetInfo$street)
StreetInfo$street <- sub("\\<WAY\\>", "CAUSEWAY", StreetInfo$street)
StreetInfo$street <- sub("\\<WALK\\>", "WALK", StreetInfo$street)
StreetInfo$street <- sub("\\<PARK\\>", "PARK", StreetInfo$street)
StreetInfo$street <- sub("\\<EN\\>", "EN", StreetInfo$street)
StreetInfo$street <- sub("\\<HL\\>", "HILL", StreetInfo$street)
StreetInfo$street <- sub("\\<TRL\\>", "TRAIL", StreetInfo$street)
StreetInfo$street <- sub("\\<TUNL\\>", "TUNNEL", StreetInfo$street)
StreetInfo$street <- sub("\\<HTS\\>", "HEIGHTS", StreetInfo$street)
StreetInfo$street <- sub("\\<FWY\\>", "FREEWAY", StreetInfo$street)
StreetInfo$street <- sub("\\<PT\\>", "POINT", StreetInfo$street)
StreetInfo$street <- sub("\\<GLN\\>", "GLEN", StreetInfo$street)
StreetInfo$street <- sub("\\<TPKE\\>", "TURNPIKE", StreetInfo$street)
StreetInfo$street <- sub("\\<EXT\\>", "EXTENSION", StreetInfo$street)
StreetInfo$street <- sub("\\<PATH\\>", "PATH", StreetInfo$street)
StreetInfo$street <- sub("\\<GDNS\\>", "GARDENS", StreetInfo$street)
StreetInfo$street <- sub("\\<ROAD\\>", "ROAD", StreetInfo$street)
StreetInfo$street <- sub("\\<HWY\\>", "HIGHWAY", StreetInfo$street)
StreetInfo$street <- sub("\\<LK\\>", "LAKE", StreetInfo$street)
StreetInfo$street <- sub("\\<OVAL\\>", "OVAL", StreetInfo$street)
StreetInfo$street <- sub("\\<ROW\\>", "ROW", StreetInfo$street)
StreetInfo$street <- sub("\\<RAMP\\>", "RAMP", StreetInfo$street)
StreetInfo$street <- sub("\\<SLIP\\>", "SLIP", StreetInfo$street)
StreetInfo$street <- sub("\\<VLG\\>", "VILLAGE", StreetInfo$street)
StreetInfo$street <- sub("\\<CLOS\\>", "CLOSE", StreetInfo$street)
StreetInfo$street <- sub("\\<N\\>", "NORTH", StreetInfo$street)
StreetInfo$street <- sub("\\<CRS\\>E", "COURSE", StreetInfo$street)
StreetInfo$street <- sub("\\<RMP\\>", "RAMP", StreetInfo$street)
StreetInfo$street <- sub("\\<GRN\\>", "GREEN", StreetInfo$street)
StreetInfo$street <- sub("\\<OPAS\\>", "OVERPASS", StreetInfo$street)
StreetInfo$street <- sub("\\<VIA\\>", "VIADUCT", StreetInfo$street)
StreetInfo$street <- sub("\\<RDG\\>", "RIDGE", StreetInfo$street)
StreetInfo$street <- sub("\\<BL\\>", "BOULEVARD", StreetInfo$street)
StreetInfo$street <- sub("\\<EXIT\\>", "EXIT", StreetInfo$street)
StreetInfo$street <- sub("\\<ESPL\\>", "ESPLANADE", StreetInfo$street)
StreetInfo$street <- sub("\\<MNR\\>", "MANOR", StreetInfo$street)
StreetInfo$street <- sub("\\<RDWY\\>", "ROADWAY", StreetInfo$street)
StreetInfo$street <- sub("\\<DY\\>", "DY", StreetInfo$street)
StreetInfo$street <- sub("\\<BDG\\>", "BDG", StreetInfo$street)
StreetInfo$street <- sub("\\<CP\\>", "CAMP", StreetInfo$street)


streetInfoRoads <- data.frame(streets = sort(unique(StreetInfo$street))) 
TaxiRoutesStreetsONLY <- TaxiRoutes[,21:66]
taxiRoads <- data.frame(streets = sort(unique(as.vector(as.matrix(TaxiRoutesStreetsONLY)))))

setdiff(streetInfoRoads,taxiRoads)

```


### Calculating bike lane %

```{r}
RoadsData = TaxiRoutes[,21:66]

for (i in 1:nrow(TaxiRoutes)){
  bikecount = 0
  BikeLaneTripList = vector(,nrow(TaxiRoutes))
  for (j in RoadsData[,j]){
    if (RoadsData[i,j] != "NA"){
      for (k in StreetInfo[k,]){
        if( StreetInfo[k, 3] == RoadsData[i,j]){
          if(StreetInfo[k,6] != "NA"{
            bikecount = bikecount+1
          })
        }
      }
    }
  }
  BikeLandTripList[i] = bikecount
}
```












