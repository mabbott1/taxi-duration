---
title: "Survival Project"
author: "Madeline Abbott, Katja McKiernan, Hayley Stutzman"
date: "March 1, 2018"
output: html_document
---


## Things to do:

* remove pick-up and drop-off locations that are far away or in the ocean--check for reasonables travel speeds
* remove trips with extra long durations
* remove trips with really short (like 10 second) durations
* add a rush hour variable
* Kaplan-Meier curves--trip duration by rush hour (maybe time of day), trip duration by passenger number, trip duration by pickup location (airport?), trip duration by day of the week


## Other things (later):

* control for rush hour by day
* neighborhood
* what does store and forward flag mean?


Some packages...
```{r}
library(readr)
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
library(dplyr)
library(survival)
library(geosphere)
library(lubridate)
```

## Read in data:
```{r}
Taxi <- read_csv("Taxi.csv")
```

### A first look at the data:

### Create a histogram of trip durations
```{r}
ggplot(Taxi, aes(trip_duration)) + geom_histogram(fill = "yellow", col = "black", bins = 200) + scale_x_log10()
```

### A map of pick-up locations
```{r}
states <- map_data("state")
ggplot(data = states) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = Taxi, aes(x = pickup_longitude, y = pickup_latitude), color = "black", size = 2, alpha = 0.5) 
```
### A map of drop-off locations
```{r}
ggplot(data = states) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = Taxi, aes(x = dropoff_longitude, y = dropoff_latitude), color = "black", size = 2, alpha = 0.5) 
```


### A map of long trips with duration over 12 hours (43200 seconds)
```{r}
longTaxi <- Taxi %>%
  filter(trip_duration > 43200)

ggplot(data = states) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = longTaxi, aes(x = dropoff_longitude, y = dropoff_latitude), color = "black", size = 2, alpha = 0.5) 
```

### A map of short trips with duration under 30 seconds
```{r}
shortTaxi <- Taxi %>%
  filter(trip_duration < 30)

ggplot(data = states) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = shortTaxi, aes(x = dropoff_longitude, y = dropoff_latitude), color = "black", size = 2, alpha = 0.5) 
```



## Data Cleaning:

```{r}
# So far this limits longitude to between -90 and -60 degrees, and latitude to between 37 and 43 degrees,
#cleanTaxi <- Taxi %>%
#  filter(-70 > pickup_longitude) %>% filter(pickup_longitude > -90) %>%
#  filter(37 < pickup_latitude) %>% filter(pickup_latitude < 43) %>%
#  filter(-70 > dropoff_longitude) %>% filter(dropoff_longitude > -90) %>%
#  filter(37 < dropoff_latitude) %>% filter(dropoff_latitude < 43)

# calculate average speed (approximate) and restrict to average speed of over 2 mph and under 70 mph.
#getDistance <- function(location_data) {distGeo(c(location_data[1], location_data[2]), c(location_data[3], #location_data[4]))}
#cleanTaxi$distance_traveled <- apply(cleanTaxi[c("pickup_longitude", "pickup_latitude", "dropoff_longitude", #"dropoff_latitude")], 1, getDistance)  # in meters, distance "as the crow flies"
# convert to miles
#cleanTaxi$distance_traveled <- cleanTaxi$distance_traveled*0.000621371
# get average speed
#cleanTaxi$average_speed <- cleanTaxi$distance_traveled / (cleanTaxi$trip_duration/60/60)
# filter out really slow and really fast taxis
#cleanTaxi2 <- cleanTaxi %>%
#  filter(average_speed > 2) %>% filter(average_speed < 70)

# Restricts duration to under 80000 seconds (about 22 hours) and over 10 seconds
#cleanTaxi3 <- cleanTaxi2 %>%
#  filter(trip_duration > 10) %>%
#  filter(trip_duration < 80000)


# save the cleaner version of the data
#write.csv(cleanTaxi3, file = "cleanTaxi.csv")
```


# Load in clean data

**also remove trips with 0 passengers**
```{r}
cleanTaxi <- read.csv("cleanTaxi.csv") %>%
  filter(passenger_count > 0)
```

** Make a map of the clean data**
```{r}
# make another map
states <- map_data("state")
new_york_areas <- subset(states, region %in% c("new york", "new jersey", "connecticut", "pennsylvania"))
# drop off
ggplot(data = new_york_areas) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = cleanTaxi, aes(x = dropoff_longitude, y = dropoff_latitude), color = "black", size = 2, alpha = 0.3) + xlab("Longitude") + ylab("Latitude") + ggtitle("Drop-off Locations")
# pick up
ggplot(data = new_york_areas) + geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") + coord_fixed(1.3) + guides(fill=FALSE) + geom_point(data = cleanTaxi, aes(x = pickup_longitude, y = pickup_latitude), color = "black", size = 2, alpha = 0.3) + xlab("Longitude") + ylab("Latitude") + ggtitle("Pick-up Locations")

```





# Preliminary Analysis:

** use cleanTaxi data **

## Plot trip duration with a Kaplan-Meier curve
```{r}
KM_taxi <- survfit(Surv(trip_duration) ~ 1, data = cleanTaxi)
plot(KM_taxi, col = 'purple', xlim = c(0, 23500), xlab = "Trip Duration (seconds)", ylab = "Survival Estimate", main = "Taxi Trip Duration")
```


### Find mean trip duration
```{r}
AUCKM = function(survobj,duration)
{
base=c(0,summary(survobj)$time,max(duration))
heights=c(1,summary(survobj)$surv)
new=c()
for(i in 1:length(heights)) { new=c(new,(base[i+1]-base[i])*heights[i]) }
c(sum(new))
}

AUCKM(KM_taxi, cleanTaxi$trip_duration)
```


## Trip duration by passenger number
```{r}
KM_taxi <- survfit(Surv(trip_duration) ~ as.factor(passenger_count), data = cleanTaxi)
plot(KM_taxi, col = c('red', 'orange', 'gold', 'green', 'cyan', 'purple'), xlim = c(0, 23500), xlab = "Trip Duration (seconds)", ylab = "Survival Estimate", main = "Taxi Trip Duration by Passenger Count")
legend("topright", inset = 0.05, title = "Number of passengers", legend = c("1", "2", "3", "4", "5", "6"), fill = c('red', 'orange', 'gold', 'green', 'cyan', 'purple'))
```

### Log rank test
```{r}
survdiff(Surv(trip_duration) ~ as.factor(passenger_count), data = cleanTaxi)
1 - pchisq((314.117 + 707.589 + 110.091 + 152.807 + 5.734 + 0.522), df = 5)
```




## Creating a Rush Hour variable 
```{r}
# Sample data set for adding rush hour
tripIDTest = c(1,2,3,4,5,6,7,8,9,10)
TimeTest = c(16,16, 8,9.5,6,3,1,12, 8.75, 10)
TestTaxi = data.frame(tripIDTest,TimeTest)
TestTaxi
# Function for adding a rush hour variable-this will work once we figure out a good way to extract the time of day from the dataset
CreateRush <- function(data1,timeCat){
  rush = c( 1:nrow(data1))
  for(i in 1:nrow(data1)){
    if(hour(timeCat[i]) <= 8 && hour(timeCat[i]) >= 6 ){
      rush[i] = 1
    }
    else if(hour(timeCat[i]) >= 15 && hour(timeCat[i]) <= 17){
      rush[i] = 1
    }
    else{
      rush[i] = 0
    }
  }
  return(newdata1 = (cbind(data1, rush)))
}
#newRushTestTaxi =(CreateRush(TestTaxi,TimeTest))
#newRushTestTaxi

#miniTaxi = head(cleanTaxi, 10)
#miniTaxi
#CreateRush(miniTaxi, miniTaxi$pickup_datetime)
```


```{r}
# Extracting time only from pickup info
cleanTaxi$pickup_datetime = ymd_hms(cleanTaxi$pickup_datetime)
#Adding rush hour variable to cleanTaxi
cleanTaxi = CreateRush(cleanTaxi, cleanTaxi$pickup_datetime)
#typeof( hour(cleanTaxi$pickup_datetime[3]))
#View(cleanTaxi)
```


```{r}
KMRush = survfit(Surv(cleanTaxi$trip_duration)~cleanTaxi$rush)

plot(KMRush, col = c("black", "red"), xlim= c(0,5000))

```









